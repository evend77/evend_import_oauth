<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Importer vos annonces eBay vers e-Vend</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .alert-info-custom { background-color: #d0ebff; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .alert-success-custom { background-color: #b2f2bb; border-radius: 12px; padding: 10px; margin-top: 10px; }
        .alert-warning-custom { background-color: #ffe066; border-radius: 12px; padding: 15px; }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <div class="card shadow-lg p-4 mx-auto" style="max-width: 800px; border-radius: 15px;">
        <h1 class="text-center mb-4 text-primary">üì¶ Importer vos annonces eBay vers e-Vend</h1>

        <!-- Avertissement e-Vend -->
        <div class="alert alert-danger text-center fw-bold mb-4" style="border-radius: 12px;">
            ‚ö†Ô∏è Veuillez vous connecter √† votre compte e-Vend avant de lancer la proc√©dure.
        </div>

        <!-- Bloc messages + connect√© eBay + √©tapes + log -->
        {% with messages = get_flashed_messages() %}
        {% if messages or connected %}
        <div class="alert-info-custom">
            {% if messages %}
                <h5 class="fw-bold text-center mb-3">Messages</h5>
            {% endif %}
            {% if connected %}
                <div class="alert-success-custom text-center fw-bold">
                    ‚úÖ Vous √™tes connect√© √† eBay !
                </div>
            {% endif %}

            <!-- √âtapes en cours / erreurs -->
            <div class="alert alert-info-custom mb-3">
                <h5 class="fw-bold text-center mb-2">üìå √âtapes en cours :</h5>
                <ul id="import-steps" style="max-height: 5.5em; overflow-y: auto; padding-left: 20px; margin: 0;"></ul>
            </div>

            <!-- Script JS -->
            <script>
            function addStep(message, isError=false){
                const stepsUl = document.getElementById('import-steps');
                if(!stepsUl) return;
                const li = document.createElement('li');
                li.textContent = message;
                if(isError) li.style.color='red';
                stepsUl.appendChild(li);
                stepsUl.scrollTop = stepsUl.scrollHeight;
                while(stepsUl.children.length>10){stepsUl.removeChild(stepsUl.firstChild);}
            }
            </script>

            <!-- Messages flash -->
            <ul id="import-log" style="max-height:200px; overflow-y:auto; padding-left:20px; margin-top:10px;">
                {% for message in messages %}
                    <li>{{ message }}</li>
                {% endfor %}
            </ul>

            <!-- LOG import Render -->
            <div class="alert alert-info-custom mt-3">
                <h5 class="fw-bold text-center mb-2">LOG import :</h5>
                <div id="render-log" style="white-space:pre-wrap; max-height:250px; overflow-y:auto; background:#f0f8ff; padding:10px; border-radius:8px;">
                    üîÑ Les logs d'import s'afficheront ici...
                </div>
            </div>

            <script>
            function refreshRenderLog(){
                fetch("/get_import_log")
                .then(resp=>resp.json())
                .then(data=>{
                    const logDiv=document.getElementById('render-log');
                    if(logDiv){
                        logDiv.textContent = data.log || "üîÑ Aucun log disponible pour le moment...";
                        logDiv.scrollTop = logDiv.scrollHeight;
                    }
                }).catch(err=>console.error("Erreur r√©cup√©ration logs:",err));
            }
            setInterval(refreshRenderLog,3000);
            refreshRenderLog();
            </script>

        </div>
        {% endif %}
        {% endwith %}

        {% if not connected %}
            <div class="text-center">
                <p class="mb-3">Vous devez connecter votre compte eBay pour continuer.</p>
                <a href="{{ url_for('login_ebay') }}" class="btn btn-primary btn-lg w-100">üîë Se connecter avec eBay</a>
            </div>
        {% else %}
            <!-- √âtape 1 -->
            <div class="mb-4">
                <h2 class="h5 text-secondary fw-bold">√âtape 1: T√©l√©charger vos annonces eBay</h2>
                <p>Exportez vos annonces eBay au format CSV pour les pr√©parer √† l‚Äôimportation sur e-Vend.</p>
                {% if remaining_quota > 0 %}
                    <a href="{{ url_for('download_ebay_csv') }}" class="btn btn-success btn-lg w-100">‚¨áÔ∏è T√©l√©charger mon CSV eBay</a>
                {% else %}
                    <button class="btn btn-outline-secondary btn-lg w-100" disabled>‚ö†Ô∏è Quota journalier atteint</button>
                {% endif %}
            </div>

            <!-- √âtape 2 : Importer CSV -->
            <div class="mb-4">
                <h2 class="h5 text-secondary fw-bold">√âtape 2: Importer un CSV sur e-Vend</h2>
                <form action="{{ url_for('post_evend') }}" method="post" enctype="multipart/form-data">
                    <input type="file" class="form-control mb-3" name="csv_file" accept=".csv" required>

                    <!-- Identifiants e-Vend -->
                    <div class="alert alert-info-custom mb-3">
                        <h6 class="fw-bold">üîë Vos identifiants e-Vend</h6>
                        <input type="email" class="form-control mb-2" name="evend_email" placeholder="exemple@domaine.com" required>
                        <input type="password" class="form-control mb-2" name="evend_password" placeholder="Votre mot de passe" required>
                    </div>

                    <!-- Valeurs par d√©faut -->
                    <div class="alert alert-info-custom mb-3">
                        <h6 class="fw-bold">Valeurs par d√©faut (si eBay ne fournit pas)</h6>

                        <div class="mb-2">
                            <label>Type d‚Äôannonce</label>
                            <select class="form-select" name="type_annonce">
                                <option selected>Article neuf</option>
                                <option>Article d'occasion</option>
                                <option>Article remis √† neuf</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label>Cat√©gorie</label>
                            <select class="form-select" name="categorie">
                                <option selected disabled>-- S√©lectionner une cat√©gorie --</option>
                                <option value="Accessoires et bijoux">Accessoires et bijoux > Autre</option>
                                <option value="Aliments">Aliments > Autre</option>
                                <option value="Animaux">Animaux > Autre</option>
                                <option value="Antiquit√©s">Antiquit√©s > Autre</option>
                                <option value="Art">Art > Autre</option>
                                <option value="Articles pour animaux">Articles pour animaux > Autre</option>
                                <option value="Artisanat">Artisanat > Autre</option>
                                <option value="Automobile / Machinerie">Automobile / Machinerie > Autre</option>
                                <option value="Bluray">Bluray > Autre</option>
                                <option value="Bureau / papeterie">Bureau / papeterie > Autre</option>
                                <option value="CD">CD > Autre</option>
                                <option value="Collection">Collection > Autre</option>
                                <option value="Cours et jardin">Cours et jardin > Autre</option>
                                <option value="D√©coration / maison">D√©coration / maison > Autre</option>
                                <option value="DVD">DVD > Autre</option>
                                <option value="√âlectronique">√âlectronique > Autre</option>
                                <option value="Hydraulique">Hydraulique > Autre</option>
                                <option value="Jeux video / console">Jeux video / console > Autre</option>
                                <option value="Jouets / Jeux">Jouets / Jeux > Autre</option>
                                <option value="Livres">Livres > Autre</option>
                                <option value="Meuble">Meuble > Autre</option>
                                <option value="Outils">Outils > Autre</option>
                                <option value="Produits hygi√®ne et beaut√©">Produits hygi√®ne et beaut√© > Autre</option>
                                <option value="Quincaillerie">Quincaillerie > Autre</option>
                                <option value="Sports et plein-air">Sports et plein-air > Autre</option>
                                <option value="V√™tements / Chaussures et accessoires">V√™tements / Chaussures et accessoires > Autre</option>
                                <option value="Vinyles / VHS / Cassettes">Vinyles / VHS / Cassettes > Autre</option>
                                <option value="Autre / Divers">Autre / Divers > Autre</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label>Titre de l'annonce</label>
                            <input type="text" class="form-control" name="titre" placeholder="Ex : Magnifique montre vintage">
                        </div>

                        <div class="mb-2">
                            <label>Descriptif de l'annonce</label>
                            <textarea class="form-control" name="description" placeholder="D√©crivez votre article ici..."></textarea>
                        </div>

                        <div class="mb-2">
                            <label>√âtat de l'article</label>
                            <select class="form-select" name="condition">
                                <option selected>1. Neuf / Jamais utilis√©</option>
                                <option>2. Comme neuf</option>
                                <option>3. Tr√®s bon √©tat</option>
                                <option>4. Bon √©tat</option>
                                <option>5. √âtat correct</option>
                                <option>6. Us√© / Bien utilis√©</option>
                                <option>7. √Ä r√©parer</option>
                                <option>8. Pour pi√®ces</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label>Retour offert</label>
                            <select class="form-select" name="retour">
                                <option selected>Non, aucun retour accept√©</option>
                                <option>Oui, retour sous 30 jours</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label>Garantie offerte</label>
                            <select class="form-select" name="garantie">
                                <option selected>Non, aucune garantie n'est offerte</option>
                                <option>Oui, une garantie est offerte</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label>Prix ($)</label>
                            <input type="number" class="form-control" name="prix" value="5" min="0">
                        </div>

                        <div class="mb-2">
                            <label>Stock</label>
                            <input type="number" class="form-control" name="stock" value="1" min="1">
                        </div>

                        <div class="mb-2">
                            <h6 class="fw-bold">Options de livraison</h6>
                            <div class="form-check mb-1">
                                <input class="form-check-input" type="checkbox" name="livraison_ramassage_check" id="livraison_ramassage_check">
                                <label class="form-check-label" for="livraison_ramassage_check">Ramassage sur place</label>
                            </div>
                            <input type="text" class="form-control mb-2" name="livraison_ramassage" placeholder="Adresse du ramassage" value="123 Rue Exemple, Montr√©al">
                            <div class="form-check mb-1">
                                <input class="form-check-input" type="checkbox" name="livraison_expedition_check" id="livraison_expedition_check" checked>
                                <label class="form-check-label" for="livraison_expedition_check">Exp√©dition par transporteur</label>
                            </div>
                            <input type="number" class="form-control mb-1" name="frais_port_article" value="5">
                            <input type="number" class="form-control mb-1" name="frais_port_sup" value="2">
                        </div>

                        <div class="mb-2">
                            <label>Photo par d√©faut</label>
                            <input type="text" class="form-control" name="photo_defaut" value="https://drive.google.com/file/d/1Hxe2ZKcGDD1TSaQzP8ho0GRoj4Cio7n3/view?usp=sharing">
                        </div>

                    </div>
                    <button type="submit" class="btn btn-success btn-lg w-100 mb-3">üì§ Importer sur e-Vend</button>
                </form>
            </div>

            <!-- R√©initialiser CSV -->
            <div class="mb-4">
                <form action="{{ url_for('reset_csv') }}" method="post">
                    <button type="submit" class="btn btn-warning btn-lg w-100">üîÑ Supprimer le dernier CSV</button>
                </form>
            </div>

            <!-- D√©connexion eBay -->
            <div class="mb-4">
                <a href="{{ url_for('logout_ebay') }}" class="btn btn-danger btn-lg w-100 mt-2">üîì Se d√©connecter de eBay</a>
            </div>

        {% endif %}

    </div>
</div>
</body>
</html>
