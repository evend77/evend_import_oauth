<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Importer vos annonces eBay vers e-Vend</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .alert-info-custom { background-color: #d0ebff; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .alert-success-custom { background-color: #b2f2bb; border-radius: 12px; padding: 10px; margin-top: 10px; }
        .alert-warning-custom { background-color: #ffe066; border-radius: 12px; padding: 15px; }
        #selenium-log { max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <div class="card shadow-lg p-4 mx-auto" style="max-width: 800px; border-radius: 15px;">

        <h1 class="text-center mb-4 text-primary">üì¶ Importer vos annonces eBay vers e-Vend</h1>

        <!-- Avertissement e-Vend -->
        <div class="alert alert-danger text-center fw-bold mb-4" style="border-radius: 12px;">
            ‚ö†Ô∏è Veuillez vous connecter √† votre compte e-Vend avant de lancer la proc√©dure.
        </div>

        <!-- Messages & Connexion -->
        {% with messages = get_flashed_messages() %}
        {% if messages or connected %}
            <div class="alert-info-custom">
                {% if messages %}
                    <h5 class="fw-bold text-center mb-3">Messages</h5>
                    <ul class="mb-0">
                        {% for message in messages %}
                            <li>{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                {% if connected %}
                    <div class="alert-success-custom text-center fw-bold">
                        ‚úÖ Vous √™tes connect√© √† eBay !
                    </div>
                {% endif %}
            </div>
        {% endif %}
        {% endwith %}

        {% if not connected %}
            <div class="text-center">
                <p class="mb-3">Vous devez connecter votre compte eBay pour continuer.</p>
                <a href="{{ url_for('login_ebay') }}" class="btn btn-primary btn-lg w-100">
                    üîë Se connecter avec eBay
                </a>
            </div>
        {% else %}
            <!-- √âtape 1 : T√©l√©charger vos annonces eBay -->
            <div class="mb-4">
                <h2 class="h5 text-secondary" style="font-weight: 900;"><strong>√âtape 1: T√©l√©charger vos annonces eBay</strong></h2>
                <p>Exportez vos annonces eBay au format CSV pour pr√©parer l‚Äôimport sur e-Vend. V√©rifiez vos informations avant l‚Äôimport.</p>
                {% if remaining_quota > 0 %}
                    <a href="{{ url_for('download_ebay_csv') }}" class="btn btn-success btn-lg w-100">
                        ‚¨áÔ∏è T√©l√©charger mon CSV eBay
                    </a>
                {% else %}
                    <button class="btn btn-outline-secondary btn-lg w-100" disabled>
                        ‚ö†Ô∏è Quota journalier atteint
                    </button>
                {% endif %}
            </div>

            <!-- √âtape 2 : Importer CSV sur e-Vend -->
            <div class="mb-4">
                <h2 class="h5 text-secondary" style="font-weight: 900;"><strong>√âtape 2: Importer un CSV sur e-Vend</strong></h2>
                <p>Importez le CSV v√©rifi√©. Renseignez les valeurs par d√©faut si eBay ne fournit pas certaines informations.</p>
                <form action="{{ url_for('post_evend') }}" method="post" enctype="multipart/form-data">
                    <input type="file" class="form-control mb-3" name="csv_file" accept=".csv" required>

                    <div class="alert alert-info-custom mb-3">
                        <h6 class="fw-bold">Valeurs par d√©faut (si eBay ne fournit pas)</h6>
                        <!-- Type d'annonce -->
                        <div class="mb-2">
                            <label class="form-label">Type d‚Äôannonce</label>
                            <select class="form-select" name="type_annonce">
                                <option selected>Article neuf</option>
                                <option>Article d'occasion</option>
                                <option>Article remis √† neuf</option>
                            </select>
                        </div>
                        <!-- Cat√©gorie -->
                        <div class="mb-2">
                            <label class="form-label">Cat√©gorie</label>
                            <select class="form-select" name="categorie">
                                <option selected disabled>-- S√©lectionner une cat√©gorie --</option>
                                <option value="Accessoires et bijoux">Accessoires et bijoux > Autre</option>
                                <option value="Aliments">Aliments > Autre</option>
                                <option value="Animaux">Animaux > Autre</option>
                                <option value="Antiquit√©s">Antiquit√©s > Autre</option>
                                <option value="Art">Art > Autre</option>
                                <option value="Articles pour animaux">Articles pour animaux > Autre</option>
                                <option value="Artisanat">Artisanat > Autre</option>
                                <option value="Automobile / Machinerie">Automobile / Machinerie > Autre</option>
                                <option value="Bluray">Bluray > Autre</option>
                                <option value="Bureau / papeterie">Bureau / papeterie > Autre</option>
                                <option value="CD">CD > Autre</option>
                                <option value="Collection">Collection > Autre</option>
                                <option value="Cours et jardin">Cours et jardin > Autre</option>
                                <option value="D√©coration / maison">D√©coration / maison > Autre</option>
                                <option value="DVD">DVD > Autre</option>
                                <option value="√âlectronique">√âlectronique > Autre</option>
                                <option value="Hydraulique">Hydraulique > Autre</option>
                                <option value="Jeux video / console">Jeux video / console > Autre</option>
                                <option value="Jouets / Jeux">Jouets / Jeux > Autre</option>
                                <option value="Livres">Livres > Autre</option>
                                <option value="Meuble">Meuble > Autre</option>
                                <option value="Outils">Outils > Autre</option>
                                <option value="Produits hygi√®ne et beaut√©">Produits hygi√®ne et beaut√© > Autre</option>
                                <option value="Quincaillerie">Quincaillerie > Autre</option>
                                <option value="Sports et plein-air">Sports et plein-air > Autre</option>
                                <option value="V√™tements / Chaussures et accessoires">V√™tements / Chaussures et accessoires > Autre</option>
                                <option value="Vinyles / VHS / Cassettes">Vinyles / VHS / Cassettes > Autre</option>
                                <option value="Autre / Divers">Autre / Divers > Autre</option>
                            </select>
                        </div>
                        <!-- Titre -->
                        <div class="mb-2">
                            <label class="form-label">Titre de l'annonce</label>
                            <input type="text" class="form-control" name="titre" placeholder="Ex : Magnifique montre vintage">
                        </div>
                        <!-- Descriptif -->
                        <div class="mb-2">
                            <label class="form-label">Descriptif de l'annonce</label>
                            <textarea class="form-control" name="description" placeholder="D√©crivez votre article ici..."></textarea>
                        </div>
                        <!-- √âtat -->
                        <div class="mb-2">
                            <label class="form-label">√âtat de l'article (condition)</label>
                            <select class="form-select" name="condition">
                                <option selected>1. Neuf / Jamais utilis√©</option>
                                <option>2. Comme neuf</option>
                                <option>3. Tr√®s bon √©tat</option>
                                <option>4. Bon √©tat</option>
                                <option>5. √âtat correct</option>
                                <option>6. Us√© / Bien utilis√©</option>
                                <option>7. √Ä r√©parer</option>
                                <option>8. Pour pi√®ces</option>
                            </select>
                        </div>
                        <!-- Retour -->
                        <div class="mb-2">
                            <label class="form-label">Retour offert</label>
                            <select class="form-select" name="retour">
                                <option selected>Non, aucun retour accept√©</option>
                                <option>Oui, retour sous 30 jours apr√®s date d'achat</option>
                            </select>
                        </div>
                        <!-- Garantie -->
                        <div class="mb-2">
                            <label class="form-label">Garantie offerte</label>
                            <select class="form-select" name="garantie">
                                <option selected>Non, aucune garantie n'est offerte</option>
                                <option>Oui, une garantie est offerte</option>
                            </select>
                        </div>
                        <!-- Prix -->
                        <div class="mb-2">
                            <label class="form-label">Prix ($)</label>
                            <input type="number" class="form-control" name="prix" value="5" min="0">
                        </div>
                        <!-- Stock -->
                        <div class="mb-2">
                            <label class="form-label">Stock</label>
                            <input type="number" class="form-control" name="stock" value="1" min="1">
                        </div>
                        <!-- Livraison -->
                        <div class="mb-2">
                            <label class="form-label">Options de livraison</label>
                            <select class="form-select mb-1" name="livraison_type">
                                <option selected>Ramassage sur place</option>
                                <option>Exp√©dition par transporteur</option>
                            </select>
                            <input type="text" class="form-control mb-1" name="livraison_ramassage" placeholder="Adresse du ramassage">
                            <input type="number" class="form-control mb-1" name="frais_port_article" placeholder="Frais de port ($)">
                            <input type="number" class="form-control mb-1" name="frais_port_sup" placeholder="Frais de port suppl√©mentaires ($)">
                        </div>
                        <!-- Photo -->
                        <div class="mb-2">
                            <label class="form-label">Photo par d√©faut</label>
                            <input type="text" class="form-control" name="photo_defaut" value="https://drive.google.com/file/d/1Hxe2ZKcGDD1TSaQzP8ho0GRoj4Cio7n3/view?usp=sharing">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-lg w-100 mb-3">üì§ Importer sur e-Vend</button>
                </form>
            </div>

            <!-- R√©initialiser CSV -->
            <div class="mb-4">
                <h2 class="h5 text-secondary" style="font-weight: 900;"><strong>üßπ R√©initialiser le dernier CSV eBay</strong></h2>
                <form action="{{ url_for('reset_csv') }}" method="post">
                    <button type="submit" class="btn btn-warning btn-lg w-100">
                        üîÑ Supprimer le dernier CSV
                    </button>
                </form>
            </div>

            <!-- D√©connexion eBay -->
            <div class="mb-4">
                <h2 class="h5 text-secondary" style="font-weight: 900;"><strong>üîì Vous pouvez vous d√©connecter de eBay ici</strong></h2>
                <div class="text-center">
                    <a href="{{ url_for('logout_ebay') }}" class="btn btn-danger btn-lg w-100 mt-2">
                        üîì Se d√©connecter de eBay
                    </a>
                </div>
            </div>

            <!-- LOG IMPORT -->
            <div class="alert alert-info-custom mt-4">
                <h5 class="fw-bold">LOG IMPORT</h5>
                <div id="selenium-log"></div>
            </div>

            <!-- Limites -->
            <div class="alert alert-warning-custom mt-4">
                <h5 class="fw-bold">‚ö†Ô∏è Limites d'importation :</h5>
                <ul class="mb-0">
                    <li>üìÅ <strong>500 articles maximum</strong> par fichier CSV</li>
                    <li>üìÖ <strong>2000 articles maximum</strong> par utilisateur et par jour</li>
                </ul>
            </div>

            <!-- Suivi aujourd'hui -->
            <div class="alert alert-warning-custom mt-3 text-center">
                <h5 class="fw-bold">üìä Suivi aujourd'hui</h5>
                <p class="mb-0">Articles import√©s aujourd'hui : <strong>{{ today_imported }}</strong></p>
                <p class="mb-0">Articles restants disponibles : <strong>{{ remaining_quota }}</strong></p>
            </div>

        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function fetchLogs() {
    try {
        const response = await fetch('{{ url_for("get_import_log") }}');
        if (response.ok) {
            const data = await response.json();
            const logDiv = document.getElementById("selenium-log");
            logDiv.innerHTML = "";
            data.log.split("\n").forEach(line => {
                const p = document.createElement("div");
                p.textContent = line;
                logDiv.appendChild(p);
            });
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    } catch (err) {
        console.error("Erreur fetch logs:", err);
    }
}
setInterval(fetchLogs, 2000);
fetchLogs();
</script>


